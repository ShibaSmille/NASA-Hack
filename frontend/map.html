<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="map.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <div id="map"></div>

    <button class="back" type="button" onclick="history.back()">←</button>
    <div class="hint">Point the place</div>

    <script>
        // 1) Ініціалізація мапи
        const map = L.map('map', { zoomControl: true }).setView([50.45, 30.52], 6);

        // 2) Тайли + атрибуція (обов'язково для OSM)
        L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
                maxZoom: 19,
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }
        ).addTo(map);

        let pin;

        // Збереження і перехід
        function goToTime(lat, lon, name) {
            localStorage.setItem("chosenPlace", JSON.stringify({ lat, lon, name }));
            location.href = "time.html";
        }

        // 3) Клік по мапі
        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;

            if (pin) map.removeLayer(pin);
            pin = L.marker([lat, lng]).addTo(map);

            // Спроба reverse geocoding з явними параметрами
            const base = 'https://nominatim.openstreetmap.org/reverse';
            const params = new URLSearchParams({
                format: 'json',
                lat: lat,
                lon: lng,
                zoom: '10',
                addressdetails: '1',
                'accept-language': 'uk',
                email: 'example@email.com' // заміни на свій контакт (Nominatim policy)
            });

            try {
                const res = await fetch(`${base}?${params.toString()}`, {
                    headers: { 'Accept': 'application/json' }
                });
                if (!res.ok) throw new Error('Reverse geocoding failed');
                const data = await res.json();

                const name =
                    data.display_name ||
                    `Lat ${lat.toFixed(2)}, Lon ${lng.toFixed(2)}`;

                pin.bindPopup(name).openPopup();

                // Невелика пауза, щоб користувач побачив підказку, і тоді перехід
                setTimeout(() => goToTime(lat, lng, name), 350);
            } catch (err) {
                // Фолбек без назви
                const fallback = `Lat ${lat.toFixed(2)}, Lon ${lng.toFixed(2)}`;
                pin.bindPopup(fallback).openPopup();
                setTimeout(() => goToTime(lat, lng, fallback), 350);
            }
        });
    </script>
</body>

</html>