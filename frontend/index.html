<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will It Rain On My Parade? (NASA Predictor)</title>
    <!-- Connecting Tailwind CSS CDN for styling and Inter font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set light background for the body */
        body {
            background-color: #F8F9FA;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 5rem 1rem; /* Padding for desktop and mobile */
        }
        /* Main container (white card) */
        .app-container {
            width: 100%;
            max-width: 900px;
            background-color: white;
            border-radius: 0.75rem; /* Slightly more rounded */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            padding: 2.5rem;
        }
        /* Loading animation */
        .spinner {
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for error box */
        .error-box {
            background-color: #fcebeb; /* Light pink background */
            border: 1px solid #e57373; /* Red border */
            color: #b71c1c; /* Dark red text */
            padding: 1.5rem; /* Increased padding */
            border-radius: 0.5rem;
            text-align: left;
        }
    </style>
</head>
<body>

    <!-- Main application container -->
    <div class="app-container">
        
        <!-- Header -->
        <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-2">
            Weather Risk Forecast (NASA Space Apps)
        </h1>
        <p class="text-gray-600 text-center mb-8">
            Analyzing 40 years of historical NASA POWER data for reliable activity planning.
        </p>

        <!-- Data Input Form -->
        <div class="flex flex-col md:flex-row gap-4 mb-6 items-end">
            
            <!-- Location Input -->
            <div class="w-full md:w-1/3">
                <label for="location-input" class="block text-sm font-semibold text-gray-700 mb-1">Location (City Name)</label>
                <input 
                    type="text" 
                    id="location-input" 
                    placeholder="E.g.: New York, London, Kyiv"
                    class="w-full p-3 rounded-lg border border-gray-300 bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:border-blue-500 transition duration-150"
                >
            </div>
            
            <!-- Date Input -->
            <div class="w-full md:w-1/4">
                <label for="date-input" class="block text-sm font-semibold text-gray-700 mb-1">Date (YYYY-MM-DD)</label>
                <input 
                    type="date" 
                    id="date-input" 
                    class="w-full p-3 rounded-lg border border-gray-300 bg-white text-gray-800 focus:outline-none focus:border-blue-500 transition duration-150"
                >
            </div>
            
            <!-- Activity Select -->
            <div class="w-full md:w-1/4">
                <label for="activity-select" class="block text-sm font-semibold text-gray-700 mb-1">Activity</label>
                <select 
                    id="activity-select"
                    class="w-full p-3 rounded-lg border border-gray-300 bg-white text-gray-800 focus:outline-none focus:border-blue-500 transition duration-150"
                >
                    <option value="Beach">Beach Day</option>
                    <option value="Skiing">Skiing / Winter Sports</option>
                    <option value="Hiking">Hiking / Trekking</option>
                    <option value="Fishing">Fishing</option>
                    <option value="Festival">Outdoor Festival</option>
                </select>
            </div>

            <!-- Calculation Button -->
            <button 
                id="calculate-button"
                onclick="handleCalculation()" 
                class="w-full md:w-1/5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50"
            >
                Show Probability
            </button>
        </div>

        <!-- Output Container for Results and Errors -->
        <div id="output-container" class="mt-8 bg-gray-50 p-6 rounded-xl border border-gray-200 min-h-[120px] flex flex-col items-center justify-center">
            <p id="output-text" class="text-gray-500 text-center text-lg">
                Enter a location and date to analyze the historical weather risk.
            </p>
            <!-- Loading Spinner (hidden by default) is managed by innerHTML manipulation in JS -->
        </div>
        
    </div>

    <script>
        // === DOM Variables ===
        const locationInput = document.getElementById('location-input');
        const dateInput = document.getElementById('date-input');
        const activitySelect = document.getElementById('activity-select');
        const outputText = document.getElementById('output-text');
        const outputContainer = document.getElementById('output-container');
        const calculateButton = document.getElementById('calculate-button');
        // NOTE: The API URL is set to the provided local Flask server endpoint
        const API_URL = "http://127.0.0.1:5000/calculate_risk"; 

        // Helper function for managing loading state and messages
        function setLoading(isLoading, message = "Calculating Risk...") {
            calculateButton.disabled = isLoading;
            outputContainer.classList.remove('error-box'); // Remove error style
            
            if (isLoading) {
                // Set custom loading state with spinner and message
                calculateButton.textContent = message;
                outputContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="spinner w-8 h-8 border-4 border-blue-500"></div>
                        <p class="mt-3 text-blue-600 font-medium text-center">${message}</p>
                    </div>
                `;
                outputContainer.classList.remove('flex-col', 'items-center', 'justify-center');
                outputContainer.classList.add('flex', 'items-center', 'justify-center');

            } else {
                // Reset to default state
                calculateButton.textContent = 'Show Probability';
                outputContainer.classList.add('flex-col', 'items-center', 'justify-center');
                outputContainer.classList.remove('flex', 'items-center', 'justify-content');
                // The result content will be set by the successful response handler
            }
        }
        
        // Helper function to display errors in the designated style
        function displayError(title, details) {
            setLoading(false);
            outputContainer.classList.add('error-box');
            outputContainer.classList.remove('justify-center'); // Align text to start in error box
            
            outputContainer.innerHTML = `
                <p class="font-bold text-lg">${title}</p>
                <ol class="list-disc list-inside ml-4 mt-2 text-sm space-y-1">
                    <li>Ensure all fields are filled correctly.</li>
                    <li>Verify the city name and country (e.g., 'Kyiv, Ukraine').</li>
                    <li>Check that your Python server is running and accessible at: ${API_URL}</li>
                </ol>
                <p class="text-xs mt-3 opacity-80">Error details: ${details}</p>
            `;
        }
        
        // Get risk level text, color class, and color for the progress bar based on percentage
        function getRiskDisplay(percentage) {
            let level = 'Low';
            let colorClass = 'text-green-600';
            let barColor = 'bg-green-500';

            if (percentage >= 50) {
                level = 'High';
                colorClass = 'text-red-600';
                barColor = 'bg-red-500';
            } else if (percentage >= 25) {
                level = 'Medium';
                colorClass = 'text-yellow-600';
                barColor = 'bg-yellow-500';
            }
            return { level, colorClass, barColor };
        }

        // Main Calculation Handler
        async function handleCalculation() {
            const locationName = locationInput.value.trim();
            const date = dateInput.value;
            const activity = activitySelect.value;
            const activityDisplayName = activitySelect.options[activitySelect.selectedIndex].text;
            
            if (!locationName || !date) {
                displayError("INPUT ERROR", "Please fill in the Location and Date fields. Analysis cannot proceed without them.");
                return;
            }

            setLoading(true, "Step 1/2: Geocoding Location...");
            
            const payload = {
                location: locationName,
                date: date,
                activity: activity
            };

            try {
                const maxRetries = 3;
                let response = null;
                
                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    setLoading(true, `Step 2/2: Analyzing 40 years of NASA data... (Attempt ${attempt + 1}/${maxRetries})`);
                    
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        // Break retry loop on success or definitive client/server error
                        if (response.ok || response.status === 400 || response.status === 404) {
                            break; 
                        }
                        
                    } catch (fetchError) {
                        if (attempt === maxRetries - 1) {
                            throw new Error(`Failed to connect to server: ${fetchError.message}`);
                        }
                        // Exponential backoff delay
                        const delay = Math.pow(2, attempt) * 1000;
                        console.warn(`Fetch attempt ${attempt + 1} failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                
                if (!response) {
                    throw new Error("Server did not respond after multiple retries.");
                }

                const result = await response.json();

                if (!response.ok) {
                    // Handle server-side validation/errors (e.g., location not found, insufficient data)
                    const errorMessage = result.error || `Server responded with status ${response.status}.`;
                    displayError("CALCULATION FAILED", errorMessage);
                    return;
                }
                
                // --- Display Successful Result ---
                const riskPercentage = Math.round(result.risk_percentage);
                const { level, colorClass, barColor } = getRiskDisplay(riskPercentage);
                const totalYearsAnalyzed = result.total_years_analyzed || "40+"; // Use fallback if not provided

                const resultHtml = `
                    <div class="w-full text-center">
                        <p class="text-blue-600 font-bold text-2xl mb-4">Risk Forecast Result</p>
                        
                        <div class="text-gray-700 mb-6 flex flex-wrap justify-center text-sm">
                            <span class="font-bold text-gray-800 mx-2">Location:</span> ${locationName}
                            <span class="font-bold text-gray-800 mx-2">Date:</span> ${date}
                            <span class="font-bold text-gray-800 mx-2">Activity:</span> ${activityDisplayName}
                        </div>

                        <!-- Progress Bar / Risk Visualization -->
                        <div class="relative w-full md:w-3/4 mx-auto pt-1">
                            
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${level === 'Low' ? 'text-green-600 bg-green-200' : level === 'Medium' ? 'text-yellow-600 bg-yellow-200' : 'text-red-600 bg-red-200'}">
                                        RISK LEVEL
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-4xl font-extrabold ${colorClass}">
                                        ${riskPercentage}%
                                    </span>
                                </div>
                            </div>

                            <!-- The Bar itself -->
                            <div class="flex h-4 mb-4 overflow-hidden text-xs flex rounded-full bg-gray-200">
                                <div style="width: ${riskPercentage}%;" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center rounded-full ${barColor} transition-all duration-700 ease-out"></div>
                            </div>
                        </div>
                        
                        <p class="text-xl text-gray-700 mt-4 font-semibold">The calculated risk of unsuitable weather is: <span class="${colorClass}">${level}</span>.</p>
                        
                        <p class="text-xs text-gray-500 pt-3">
                            * Percentage calculated based on ${totalYearsAnalyzed} years of historical NASA POWER data.
                        </p>
                        <p class="text-xs text-gray-500">
                            Source: <a href="${result.source_link}" target="_blank" class="text-blue-500 hover:underline">${result.source_link}</a>
                        </p>
                    </div>
                `;
                
                outputContainer.classList.remove('error-box');
                outputContainer.classList.add('flex-col', 'justify-start');
                outputContainer.innerHTML = resultHtml;
                setLoading(false);

            } catch (error) {
                console.error("Critical calculation error:", error);
                displayError("NETWORK OR LOGIC ERROR", error.message);
            }
        }

        // Add ability to trigger on Enter key press in the location field
        locationInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                handleCalculation();
            }
        });
        
        // Set default date and minimum date on load
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            // NASA POWER data starts in 1984, ensuring user cannot select dates before the data range
            dateInput.min = "1984-01-01"; 
        };

    </script>

</body>
</html>
