<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прогноз Ризику Погоди</title>
    <!-- Подключение Tailwind CSS CDN для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Устанавливаем светлый фон для тела страницы */
        body {
            background-color: #F8F9FA; /* Очень светлый серый/белый фон, как на скриншоте */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: flex-start; /* Начинаем сверху */
            justify-content: center;
            padding-top: 5rem; /* Отступ сверху */
        }
        /* Главный контейнер (белая карточка) */
        .app-container {
            width: 100%;
            max-width: 900px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
        }
        /* Анимация загрузки */
        .spinner {
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Стиль для input[type="date"] чтобы он выглядел как остальные */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none; /* Возвращаем стандартный цвет иконки календаря для светлой темы */
        }
        /* Стиль для ошибки, имитирующий скриншот */
        .error-box {
            background-color: #fcebeb; /* Светло-розовый фон */
            border: 1px solid #e57373; /* Красная рамка */
            color: #b71c1c; /* Темно-красный текст */
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Will It Rain On My Parade?</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body class="p-4">

    <!-- Основной контейнер приложения, имитирующий "белую карточку" -->
    <div class="app-container">
        
        <!-- Заголовок, как на скриншоте -->
        <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-2">
            Прогноз Ризику Погоди (NASA Space Apps)
        </h1>
        <p class="text-gray-600 text-center mb-8">
            Аналіз історичних даних MERRA-2 (імітація Data Rods) для планування активності.
        </p>

        <!-- Форма ввода данных -->
        <div class="flex flex-col md:flex-row gap-4 mb-6 items-end">
            
            <!-- Поле Города -->
            <div class="w-full md:w-1/3">
                <label for="city-input" class="block text-sm font-semibold text-gray-700 mb-1">Місто (Назва Міста)</label>
                <input 
                    type="text" 
                    id="city-input" 
                    placeholder="Наприклад: New York"
                    class="w-full p-3 rounded-lg border border-gray-300 bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:border-blue-500 transition duration-150"
                >
            </div>
            
            <!-- Поле Дата -->
            <div class="w-full md:w-1/4">
                <label for="date-input" class="block text-sm font-semibold text-gray-700 mb-1">Дата (РРРР-ММ-ДД)</label>
                <input 
                    type="date" 
                    id="date-input" 
                    class="w-full p-3 rounded-lg border border-gray-300 bg-white text-gray-800 focus:outline-none focus:border-blue-500 transition duration-150"
                >
            </div>
            
            <!-- Поле Активность -->
            <div class="w-full md:w-1/4">
                <label for="activity-select" class="block text-sm font-semibold text-gray-700 mb-1">Активність</label>
                <select 
                    id="activity-select"
                    class="w-full p-3 rounded-lg border border-gray-300 bg-white text-gray-800 focus:outline-none focus:border-blue-500 transition duration-150"
                >
                    <option value="Beach">Пляж (Beach)</option>
                    <option value="Skiing">Лижі (Skiing)</option>
                    <option value="Hiking">Похід (Hiking)</option>
                    <option value="Fishing">Рибалка (Fishing)</option>
                    <option value="Festival">Фестиваль (Outdoor Festival)</option>
                </select>
            </div>

            <!-- Кнопка Расчета -->
            <button 
                id="calculate-button"
                onclick="handleCalculation()" 
                class="w-full md:w-1/5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50"
            >
                Показати Ймовірність
            </button>
        </div>

        <!-- Контейнер для вывода результатов и ошибок (имитирует дизайн ошибки на скриншоте) -->
        <div id="output-container" class="mt-8 bg-gray-50 p-5 rounded-lg border border-gray-200 min-h-[100px] flex flex-col items-center justify-center">
            <p id="output-text" class="text-gray-500 text-center">
                Очікування введення даних...
            </p>
            <!-- Индикатор загрузки (скрыт по умолчанию) -->
            <div id="loading-spinner" class="hidden spinner w-8 h-8 border-4 border-blue-500"></div>
        </div>
        
    </div>

    <script>
        // === Переменные DOM ===
        const cityInput = document.getElementById('city-input');
        const dateInput = document.getElementById('date-input');
        const activitySelect = document.getElementById('activity-select');
        const outputText = document.getElementById('output-text');
        const outputContainer = document.getElementById('output-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const calculateButton = document.getElementById('calculate-button');

        // === Глобальные переменные для хранения координат ===
        let globalLat = null;
        let globalLon = null;
        
        // Вспомогательная функция для управления состоянием загрузки и сообщений
        function setLoading(isLoading, message = "Пошук координат...") {
            calculateButton.disabled = isLoading;
            outputContainer.classList.remove('error-box'); // Удаляем стиль ошибки
            
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                outputText.classList.add('hidden');
                calculateButton.textContent = message;
            } else {
                loadingSpinner.classList.add('hidden');
                outputText.classList.remove('hidden');
                calculateButton.textContent = 'Показати Ймовірність';
            }
        }
        
        // Вспомогательная функция для вывода ошибок в стиле скриншота
        function displayError(title, details) {
            setLoading(false);
            outputContainer.classList.add('error-box');
            outputText.innerHTML = `
                <p class="font-bold text-lg">${title}</p>
                <ol class="list-decimal list-inside ml-4 mt-2 text-sm space-y-1">
                    <li>Переконайтеся, що ви заповнили всі поля.</li>
                    <li>Перевірте з'єднання з інтернетом або правильність назви міста.</li>
                </ol>
                <p class="text-xs mt-3 opacity-80">Деталі помилки: ${details}</p>
            `;
        }

        // Ключевая функция, которая обращается к API Nominatim для геокодирования
        async function geocodeCity(cityName) {
            setLoading(true, "Крок 1/2: Геокодування міста...");
            
            const NOMINATIM_URL = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`;
            
            try {
                const response = await fetch(NOMINATIM_URL);
                
                if (!response.ok) {
                    throw new Error(`Помилка мережі: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const firstResult = data[0];
                    const lat = parseFloat(firstResult.lat).toFixed(4);
                    const lon = parseFloat(firstResult.lon).toFixed(4);
                    
                    globalLat = lat;
                    globalLon = lon;
                    
                    // Показываем, что геокодирование успешно и переходим к следующему шагу
                    outputText.innerHTML = `
                        <p class="text-green-600 font-semibold text-lg">✅ Геокодування успішно!</p>
                        <p class="text-gray-700 text-sm">Місто: ${firstResult.display_name.split(',')[0]} | Координати: ${lat}, ${lon}</p>
                        <p class="text-gray-500 text-sm mt-2">Перехід до аналізу даних NASA...</p>
                    `;
                    
                    return { lat, lon };

                } else {
                    displayError("ПОМИЛКА: Місто не знайдено", `Місто "${cityName}" не знайдено в базі геокодування.`);
                    return null;
                }

            } catch (error) {
                displayError("ПОМИЛКА ПІДКЛЮЧЕННЯ", `Помилка запиту до Nominatim: ${error.message}`);
                return null;
            } finally {
                // setLoading(false) вызывается в displayError или после успешного завершения getNasaData
            }
        }
        
        // *** НОВАЯ ФУНКЦИЯ: Симуляция запроса данных NASA ***
        async function getNasaData(lat, lon, date, activity) {
            setLoading(true, "Крок 2/2: Аналіз 40 років даних MERRA-2...");

            // Имитация задержки запроса к API NASA (около 2 секунд)
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Имитация логики расчета риска (случайное число)
            const riskPercentage = Math.floor(Math.random() * 60) + 10; 
            const riskLevel = riskPercentage < 25 ? 'Низький' : riskPercentage < 50 ? 'Середній' : 'Високий';
            const riskColorClass = riskPercentage < 25 ? 'text-green-600' : riskPercentage < 50 ? 'text-yellow-600' : 'text-red-600';
            
            const resultHtml = `
                <p class="text-blue-600 font-semibold text-xl mb-3">Результат Прогнозу Ризику</p>
                <div class="text-center space-y-1">
                    <p class="text-gray-700"><span class="font-bold text-gray-800">Активність:</span> ${activitySelect.options[activitySelect.selectedIndex].text} | <span class="font-bold text-gray-800">Дата:</span> ${date}</p>
                    
                    <div class="p-4 rounded-lg bg-gray-100 mt-3 border border-gray-200">
                        <p class="text-4xl font-extrabold ${riskColorClass}">${riskPercentage}%</p> 
                        <p class="text-lg text-gray-600 mt-1">Ризик поганих умов. (${riskLevel})</p>
                    </div>
                    
                    <p class="text-xs text-gray-400 pt-3">
                        * Цей відсоток розраховано на основі історичних даних NASA MERRA-2 для обраних координат.
                    </p>
                </div>
            `;
            
            outputText.innerHTML = resultHtml;
            setLoading(false);
        }


        // === Главный Обработчик Расчета ===
        async function handleCalculation() {
            const cityName = cityInput.value.trim();
            const date = dateInput.value;
            const activity = activitySelect.value;
            
            if (!cityName || !date) {
                displayError("ПОМИЛКА ВВЕДЕННЯ", "Будь ласка, заповніть поля Місто та Дата. Без них аналіз неможливий.");
                return;
            }

            // 1. Сначала выполняем геокодирование
            const coords = await geocodeCity(cityName);
            
            if (coords) {
                // 2. Если геокодирование успешно, переходим к запросу данных NASA
                await getNasaData(coords.lat, coords.lon, date, activity);
            }
        }

        // Добавляем возможность запуска по нажатию Enter
        cityInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                handleCalculation();
            }
        });
        
        // Установка даты по умолчанию и минимальной даты
        window.onload = function() {
            // Установка текущей даты в качестве значения по умолчанию
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            // Установка минимально возможной даты для MERRA-2 данных
            dateInput.min = "1979-01-01";
        };

    </script>

<body>
    <main class="screen center splash">
        
        <img src="./images/suncloud.png" alt="Sun and Cloud" class="hero-img" style="width:250px; height:200px">
        <h1>Will It Rain On My Parade?</h1>
        <a class="btn start-btn" href="plan.html">→</a>
    </main>
</body>
</html>